# Automated Pay Period Summary (Tue/Wed)

## Overview

The Pay Period Summary workflow automatically pulls timesheet data from Kimai and sends a comprehensive work summary to Mikhail via Pumble DM. This happens on **Tuesday and Wednesday** following a pay period end (when the Monday reminder was sent).

## How It Works

1. **Schedule Check**: On Tuesday/Wednesday at 6 PM EST, checks if the previous Monday was the last day of a pay period
2. **Automated Pull**: If yes, runs the `pull-kimai` script to get the latest data
3. **Data Processing**: Extracts the latest pay period data using Playwright browser automation
4. **Summary Generation**: Formats the detailed work summary with:
   - Overall compliance rate and statistics
   - Compliance table showing all team members
   - Detailed breakdown of what each person worked on
5. **Delivery**: The summary is sent to Mikhail via Pumble DM
6. **Storage**: Updated data is committed back to the repository

## Schedule

- **Tuesday**: 6 PM EST (23:00 UTC) - 24 hours after Monday reminder
- **Wednesday**: 6 PM EST (23:00 UTC) - 48 hours after Monday reminder
- **Only runs** during weeks when Monday was the last day of a pay period
- This ensures you get updates Tuesday and Wednesday of pay period end weeks only
- Can be triggered manually via GitHub Actions UI

## Manual Usage

### Preview the Summary Locally

```bash
# Preview without sending (dry run)
npm run send-summary:preview

# Send the summary immediately
npm run send-summary

# Send a specific pay period
node scripts/send-detailed-summary.js -p 27
```

### Trigger the Workflow Manually

Via GitHub UI:
1. Go to Actions tab
2. Select "Pay Period Summary (Tue/Wed)" workflow
3. Click "Run workflow"
4. Optionally specify a pay period number
5. Optionally check "skip_check" to send regardless of timing

Via CLI:
```bash
# Run with automatic period detection
gh workflow run daily-kimai-summary.yml

# With specific period
gh workflow run daily-kimai-summary.yml -f period=27

# Skip the Monday check (send regardless)
gh workflow run daily-kimai-summary.yml -f skip_check=true
```

## Summary Format

The summary includes:

### Header
- Pay period dates
- Overall compliance rate (X/Y team members)
- Total timesheet entries

### Compliance Table
```
| User           | Hours Worked | Expected | Difference | % Deviation | Status |
|----------------|--------------|----------|------------|-------------|--------|
| John Doe       |        80.00 |    80.00 |      +0.00 |       +0.0% |      ✓ |
```

### Detailed Breakdown
For each team member:
- ✓/✗ Status indicator
- Name and hours comparison
- Percentage deviation
- Bulleted list of work items with project categories

Example:
```
### ✓ Dharam Pal Singh - 80.00/80.00h (0.0%)
• Admin Panel - Programming: Fixed company management CRUD operations
• Admin Panel - Meeting: FTE Engineering Team Sync Up
• Admin Panel - Programming: Enhanced domain validation service
```

## Configuration

### Schedule
Edit `.github/workflows/daily-kimai-summary.yml`:
```yaml
schedule:
  # Run on Tuesday at 6 PM EST (23:00 UTC)
  - cron: '0 23 * * 2'
  # Run on Wednesday at 6 PM EST (23:00 UTC)
  - cron: '0 23 * * 3'
```

Note: The workflow includes logic to check if the previous Monday was a pay period end day. It will only run if that check passes.

### Recipient
The summary is always sent to Mikhail's DM. To change the recipient, edit:
- `config/channels.json` - Update the `dm_channels.bot_to_mikhail.id`
- Or modify `scripts/send-detailed-summary.js` to use a different channel

### Required Secrets

The workflow requires these GitHub Secrets:
- `PUMBLE_API_KEY` - For sending messages
- `KIMAI_USERNAME` - For browser automation login
- `KIMAI_PASSWORD` - For browser automation login

## Troubleshooting

### Workflow Failed
1. Check the Actions tab for error logs
2. Common issues:
   - Kimai login failed (check credentials)
   - Playwright browser timeout (Kimai may be slow)
   - No data available yet for current period

### Missing Data
- The script automatically falls back to the previous pay period if current period has no data
- Ensure `npm run pull-kimai` has been run at least once

### Format Issues
- If parsing fails, check `kimai-data/XX/hours-report.txt` format
- The parser expects the specific format generated by `pull-kimai`

## Related Commands

```bash
# Pull latest Kimai data
npm run pull-kimai

# Send compliance report (table only)
npm run send-compliance
npm run send-compliance:preview

# Send detailed summary (full breakdown)
npm run send-summary
npm run send-summary:preview
```

## Files

- **Workflow**: `.github/workflows/daily-kimai-summary.yml`
- **Script**: `scripts/send-detailed-summary.js`
- **Pull Script**: `scripts/pull-kimai.js`
- **Data Storage**: `kimai-data/{period-number}/`
- **Channel Config**: `config/channels.json`

## Future Enhancements

Potential improvements:
- [ ] Add summary to Slack/other platforms
- [ ] Weekly rollup summaries
- [ ] Trend analysis (compare to previous periods)
- [ ] Alerts for consistent non-compliance
- [ ] Custom scheduling per team
- [ ] Summary customization options
