name: Monday Pay Period Reminder

on:
  schedule:
    # Run every Monday at 12 PM CST (5 PM UTC during DST, 6 PM UTC during standard time)
    # Matching Koyeb configuration
    - cron: '0 17 * * 1'
    
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (bypasses date check)'
        required: false
        default: 'false'
        type: boolean
      action:
        description: 'Which action to run'
        required: false
        default: 'both'
        type: choice
        options:
          - 'both'          # Send advance notice + main reminders
          - 'advance-only'  # Only send advance notice to Mikhail
          - 'main-only'     # Only send main reminders to channels

jobs:
  send-reminders:
    # Run on schedule or when manually triggered
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'
    
    - name: Install dependencies
      run: |
        npm install
    
    - name: Send Monday Reminders
      env:
        PUMBLE_API_KEY: ${{ secrets.PUMBLE_API_KEY }}

      run: |
        echo "üìÖ Monday reminder check at $(date)"

        # Check if today is the last day of a pay period (using EST timezone)
        node -e "
        const PayPeriodCalculator = require('./shared/pay-period-calculator');
        const DateHelper = require('./shared/date-helper');
        const calc = new PayPeriodCalculator();
        const today = new Date();
        const period = calc.getCurrentPayPeriod();
        const isLastDay = calc.isLastDayOfPeriod(today);
        const todayEST = DateHelper.getDatePartsEST(today);
        const endEST = DateHelper.getDatePartsEST(period.end);
        console.log('Period', period.number, 'ends on', endEST.month + '/' + endEST.day + '/' + endEST.year, '(EST)');
        console.log('Today is', todayEST.month + '/' + todayEST.day + '/' + todayEST.year, '(EST)');
        console.log('Is last day of period?', isLastDay);
        if (!isLastDay) {
          console.log('‚è≠Ô∏è Skipping - not the last day of pay period');
          process.exit(1);
        }
        console.log('‚úÖ Proceeding - today is the last day of pay period', period.number);
        "

        # Only send if it's the last day of the period
        if [ $? -eq 0 ]; then
          echo "Sending to dev channel..."
          node scripts/send-timesheet-reminder.js -c dev

          echo "Sending to design channel..."
          node scripts/send-timesheet-reminder.js -c design
        else
          echo "Not sending reminders - not the last day of pay period"
        fi