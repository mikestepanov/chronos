name: Pay Period Summary (Tue/Wed) - DISABLED

on:
  # DISABLED: No longer using Kimai
  # schedule:
  #   # Run on Tuesday at 6 PM EST (23:00 UTC) - 24 hours after Monday reminder
  #   - cron: '0 23 * * 2'
  #   # Run on Wednesday at 6 PM EST (23:00 UTC) - 48 hours after Monday reminder
  #   - cron: '0 23 * * 3'

  workflow_dispatch:
    inputs:
      period:
        description: 'Specific pay period number (leave empty for latest)'
        required: false
        type: string
      skip_check:
        description: 'Skip the pay period check (send regardless of timing)'
        required: false
        default: 'false'
        type: boolean

jobs:
  pull-and-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: Install dependencies
      run: |
        npm install

    - name: Install Playwright browsers
      run: |
        npx playwright install --with-deps firefox

    - name: Check if this week had a pay period end
      id: check_period
      run: |
        echo "üîç Checking if recent pay period just ended..."

        node -e "
        const PayPeriodCalculator = require('./shared/pay-period-calculator');
        const calc = new PayPeriodCalculator();

        const today = new Date();
        const dayOfWeek = today.getUTCDay();
        
        // Check the last 3 days for a pay period end (covers weekend + Monday)
        let foundEndDate = null;
        for (let daysAgo = 1; daysAgo <= 3; daysAgo++) {
          const checkDate = new Date(today);
          checkDate.setUTCDate(checkDate.getUTCDate() - daysAgo);
          if (calc.isLastDayOfPeriod(checkDate)) {
            foundEndDate = checkDate;
            break;
          }
        }

        console.log('Today (UTC):', today.toISOString().split('T')[0], '- Day', dayOfWeek);
        console.log('Found pay period end?', foundEndDate ? foundEndDate.toISOString().split('T')[0] : 'NO');

        if (!foundEndDate && '${{ github.event.inputs.skip_check }}' !== 'true') {
          console.log('‚è≠Ô∏è Skipping - No pay period ended in the last 3 days');
          process.exit(1);
        }

        console.log('‚úÖ Proceeding - Pay period ended recently');
        "

        if [ $? -eq 0 ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "Skipping summary - not a pay period week"
        fi

    - name: Pull Kimai data
      if: steps.check_period.outputs.should_run == 'true'
      env:
        KIMAI_USERNAME: ${{ secrets.KIMAI_USERNAME }}
        KIMAI_PASSWORD: ${{ secrets.KIMAI_PASSWORD }}
        PLAYWRIGHT_HEADLESS: true
      run: |
        echo "üìä Pulling Kimai data at $(date)"
        npm run pull-kimai

    - name: Send detailed summary to Mikhail
      if: steps.check_period.outputs.should_run == 'true'
      env:
        PUMBLE_API_KEY: ${{ secrets.PUMBLE_API_KEY }}
      run: |
        echo "üì§ Sending detailed summary..."
        if [ -n "${{ github.event.inputs.period }}" ]; then
          node scripts/send-detailed-summary.js -p ${{ github.event.inputs.period }}
        else
          node scripts/send-detailed-summary.js
        fi

    - name: Commit updated Kimai data
      if: steps.check_period.outputs.should_run == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add all changes in kimai-data directory
        git add kimai-data/

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-update Kimai data - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        fi
